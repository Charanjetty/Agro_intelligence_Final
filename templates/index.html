{% extends "base.html" %}
{% block title %}Crop Prediction - AgroIntelligence{% endblock %}
{% block head %}
<style>
    .dashboard-container {
        background: linear-gradient(135deg, rgba(15, 118, 110, 0.95), rgba(22, 163, 74, 0.95));
        min-height: 100vh;
        padding: 3rem 0;
        position: relative;
    }

    .mode-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 24px;
        padding: 2.5rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        border: 3px solid transparent;
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }

    .mode-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(34, 197, 94, 0.1));
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
        z-index: 0;
    }

    .mode-card>* {
        position: relative;
        z-index: 1;
    }

    .mode-card:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 20px 60px rgba(22, 163, 74, 0.3);
        border-color: #10b981;
    }

    .mode-card:hover::before {
        opacity: 1;
    }

    .mode-icon {
        width: 80px;
        height: 80px;
        background: linear-gradient(135deg, #10b981, #22c55e);
        border-radius: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
    }

    .feature-badge {
        display: inline-block;
        padding: 0.75rem 1.5rem;
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        color: white;
        border-radius: 30px;
        font-size: 0.95rem;
        font-weight: 600;
        margin-bottom: 1.5rem;
        border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .btn-mode {
        width: 100%;
        padding: 1rem 2rem;
        background: linear-gradient(135deg, #10b981, #22c55e);
        color: white;
        border: none;
        border-radius: 16px;
        font-size: 1.1rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        margin-top: 1.5rem;
    }

    .btn-mode:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(16, 185, 129, 0.5);
    }

    .feature-list {
        list-style: none;
        padding: 0;
        margin: 1.5rem 0;
    }

    .feature-list li {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 0;
        font-size: 1rem;
        color: #475569;
    }

    .feature-list li i {
        color: #10b981;
        font-size: 1.25rem;
    }

    @keyframes bounce-slow {

        0%,
        100% {
            transform: translateY(-5%);
            animation-timing-function: cubic-bezier(0.8, 0, 1, 1);
        }

        50% {
            transform: translateY(0);
            animation-timing-function: cubic-bezier(0, 0, 0.2, 1);
        }
    }

    .animate-bounce-slow {
        animation: bounce-slow 3s infinite;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container -mx-4 -mt-10">
    <div class="max-w-7xl mx-auto px-4 relative z-10">

        <!-- Header -->
        <div class="text-center mb-12">
            <div class="inline-block mb-4">
                <span class="feature-badge">
                    <i class="fas fa-brain mr-2"></i>
                    AI-Powered Crop Recommendations
                </span>
            </div>
            <h1 class="text-5xl md:text-6xl font-extrabold text-white mb-4 drop-shadow-lg">
                Choose Your Prediction Mode
            </h1>
            <p class="text-xl text-white/90 max-w-3xl mx-auto leading-relaxed">
                Select the mode that best fits your needs and let our AI analyze your farm conditions
            </p>
        </div>

        <!-- Mode Selection Cards -->
        <div class="grid md:grid-cols-3 gap-8 max-w-7xl mx-auto">

            <!-- Manual Mode Card -->
            <div class="mode-card">
                <div class="mode-icon">
                    <span>üìù</span>
                </div>
                <h3 class="text-3xl font-bold text-slate-900 mb-3">Manual Mode</h3>
                <p class="text-lg text-slate-600 mb-4 leading-relaxed">
                    Have soil test data? Enter your precise NPK values, pH levels, and environmental parameters for
                    highly accurate, personalized crop recommendations.
                </p>

                <ul class="feature-list">
                    <li>
                        <i class="fas fa-check-circle"></i>
                        <span>Enter exact soil NPK values</span>
                    </li>
                    <li>
                        <i class="fas fa-check-circle"></i>
                        <span>Input pH and organic carbon levels</span>
                    </li>
                    <li>
                        <i class="fas fa-check-circle"></i>
                        <span>Specify temperature and rainfall</span>
                    </li>
                    <li>
                        <i class="fas fa-check-circle"></i>
                        <span>Get fine-tuned AI predictions</span>
                    </li>
                </ul>

                <button onclick="showForm('manual')" class="btn-mode">
                    <i class="fas fa-arrow-right mr-2"></i>
                    Start Manual Mode
                </button>
            </div>

            <!-- Auto Mode Card -->
            <div class="mode-card">
                <div class="mode-icon" style="background: linear-gradient(135deg, #3b82f6, #60a5fa);">
                    <span>ü§ñ</span>
                </div>
                <h3 class="text-3xl font-bold text-slate-900 mb-3">Auto Mode</h3>
                <p class="text-lg text-slate-600 mb-4 leading-relaxed">
                    No soil test? No problem! Just select your district in Andhra Pradesh, and our system automatically
                    uses regional data for instant recommendations.
                </p>

                <ul class="feature-list">
                    <li>
                        <i class="fas fa-check-circle" style="color: #3b82f6;"></i>
                        <span>Select your district only</span>
                    </li>
                    <li>
                        <i class="fas fa-check-circle" style="color: #3b82f6;"></i>
                        <span>Auto-filled soil parameters</span>
                    </li>
                    <li>
                        <i class="fas fa-check-circle" style="color: #3b82f6;"></i>
                        <span>Real-time weather integration</span>
                    </li>
                    <li>
                        <i class="fas fa-check-circle" style="color: #3b82f6;"></i>
                        <span>Quick and easy results</span>
                    </li>
                </ul>

                <button onclick="showForm('auto')" class="btn-mode"
                    style="background: linear-gradient(135deg, #3b82f6, #60a5fa); box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);">
                    <i class="fas fa-arrow-right mr-2"></i>
                    Start Auto Mode
                </button>
            </div>

            <!-- Suggestion Mode Card -->
            <div class="mode-card">
                <div class="mode-icon" style="background: linear-gradient(135deg, #8b5cf6, #a78bfa);">
                    <span>üí°</span>
                </div>
                <h3 class="text-3xl font-bold text-slate-900 mb-3">Suggestion Mode</h3>
                <p class="text-lg text-slate-600 mb-4 leading-relaxed">
                    Know what you want to grow? Select your crop and get a complete, AI-optimized plan for fertilizer,
                    irrigation, and more.
                </p>

                <ul class="feature-list">
                    <li>
                        <i class="fas fa-check-circle" style="color: #8b5cf6;"></i>
                        <span>Choose your specific crop</span>
                    </li>
                    <li>
                        <i class="fas fa-check-circle" style="color: #8b5cf6;"></i>
                        <span>Get detailed fertilizer plans</span>
                    </li>
                    <li>
                        <i class="fas fa-check-circle" style="color: #8b5cf6;"></i>
                        <span>Region-specific advice</span>
                    </li>
                    <li>
                        <i class="fas fa-check-circle" style="color: #8b5cf6;"></i>
                        <span>Instant expert schemes</span>
                    </li>
                </ul>

                <button onclick="showForm('suggestion')" class="btn-mode"
                    style="background: linear-gradient(135deg, #8b5cf6, #a78bfa); box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);">
                    <i class="fas fa-arrow-right mr-2"></i>
                    Get Suggestions
                </button>
            </div>

        </div>

        <!-- Manual Mode Form -->
        <div id="manual-form" class="hidden max-w-4xl mx-auto mt-12 bg-white rounded-3xl p-8 shadow-xl relative z-20">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-slate-900">Manual Prediction Mode</h3>
                <button onclick="hideForms()" class="text-slate-500 hover:text-slate-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="manualPredictionForm" onsubmit="handlePrediction(event, 'manual')" class="space-y-6">
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Nitrogen (N)</label>
                        <input type="number" name="soil_n" required
                            class="w-full px-4 py-2 border rounded-xl focus:ring-2 focus:ring-green-500 outline-none"
                            placeholder="e.g., 90">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Phosphorus (P)</label>
                        <input type="number" name="soil_p" required
                            class="w-full px-4 py-2 border rounded-xl focus:ring-2 focus:ring-green-500 outline-none"
                            placeholder="e.g., 42">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Potassium (K)</label>
                        <input type="number" name="soil_k" required
                            class="w-full px-4 py-2 border rounded-xl focus:ring-2 focus:ring-green-500 outline-none"
                            placeholder="e.g., 43">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">pH Level</label>
                        <input type="number" step="0.1" name="soil_ph" required
                            class="w-full px-4 py-2 border rounded-xl focus:ring-2 focus:ring-green-500 outline-none"
                            placeholder="e.g., 6.5">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Temperature (¬∞C)</label>
                        <input type="number" step="0.1" name="temperature" id="input-temperature"
                            class="w-full px-4 py-2 border rounded-xl focus:ring-2 focus:ring-green-500 outline-none"
                            placeholder="e.g., 28">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Humidity (%)</label>
                        <input type="number" step="0.1" name="humidity" id="input-humidity"
                            class="w-full px-4 py-2 border rounded-xl focus:ring-2 focus:ring-green-500 outline-none"
                            placeholder="e.g., 70">
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-sm font-medium text-slate-700">Rainfall (mm)</label>
                            <button type="button" onclick="autoDetectWeather()"
                                class="text-xs text-blue-600 font-bold hover:underline">
                                <i class="fas fa-location-arrow mr-1"></i>Detect
                            </button>
                        </div>
                        <input type="number" step="0.1" name="rainfall" id="input-rainfall"
                            class="w-full px-4 py-2 border rounded-xl focus:ring-2 focus:ring-green-500 outline-none"
                            placeholder="e.g., 200">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">District (Required)</label>
                        <select name="district" required
                            class="w-full px-4 py-2 border rounded-xl focus:ring-2 focus:ring-green-500 outline-none district-select">
                            <option value="">Select District</option>
                        </select>
                    </div>
                </div>
                <button type="submit"
                    class="w-full py-4 bg-green-600 text-white font-bold rounded-xl hover:bg-green-700 transition shadow-lg">
                    Get Recommendations
                </button>
            </form>
        </div>

        <!-- Auto Mode Form -->
        <div id="auto-form" class="hidden max-w-4xl mx-auto mt-12 bg-white rounded-3xl p-8 shadow-xl relative z-20">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-slate-900">Auto Prediction Mode</h3>
                <button onclick="hideForms()" class="text-slate-500 hover:text-slate-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="autoPredictionForm" onsubmit="handlePrediction(event, 'auto')" class="space-y-6">
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">District</label>
                        <select name="district" required
                            class="w-full px-4 py-2 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none district-select">
                            <option value="">Select District</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Season</label>
                        <select name="season"
                            class="w-full px-4 py-2 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="">Auto Detect</option>
                            <option value="Kharif">Kharif</option>
                            <option value="Rabi">Rabi</option>
                            <option value="Zaid">Zaid</option>
                        </select>
                    </div>
                </div>
                <button type="submit"
                    class="w-full py-4 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 transition shadow-lg">
                    Auto-Fetch Data & Predict
                </button>
            </form>
        </div>

        <!-- Suggestion Mode Form -->
        <div id="suggestion-form"
            class="hidden max-w-4xl mx-auto mt-12 bg-white rounded-3xl p-8 shadow-xl relative z-20">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-slate-900">Suggestion Mode</h3>
                <button onclick="hideForms()" class="text-slate-500 hover:text-slate-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="suggestionForm" onsubmit="handleSuggestion(event)" class="space-y-6">
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">District</label>
                        <select name="district" required
                            class="w-full px-4 py-2 border rounded-xl focus:ring-2 focus:ring-purple-500 outline-none district-select">
                            <option value="">Select District</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Season</label>
                        <select name="season" required
                            class="w-full px-4 py-2 border rounded-xl focus:ring-2 focus:ring-purple-500 outline-none">
                            <option value="Kharif">Kharif</option>
                            <option value="Rabi">Rabi</option>
                            <option value="Zaid">Zaid</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Crop</label>
                    <select name="crop" required
                        class="w-full px-4 py-2 border rounded-xl focus:ring-2 focus:ring-purple-500 outline-none">
                        <option value="">Select Crop</option>
                        <option value="Paddy">Paddy (Rice)</option>
                        <option value="Maize">Maize (Corn)</option>
                        <option value="Cotton">Cotton</option>
                        <option value="Groundnut">Groundnut</option>
                        <option value="Chilli">Chilli</option>
                    </select>
                </div>
                <button type="submit"
                    class="w-full py-4 bg-purple-600 text-white font-bold rounded-xl hover:bg-purple-700 transition shadow-lg">
                    Get Detailed Suggestions
                </button>
            </form>
        </div>

        <!-- Results Section -->
        <div id="results-section" class="hidden max-w-4xl mx-auto mt-12 relative z-20">
            <div class="bg-white rounded-3xl p-8 shadow-xl border-2 border-green-100">
                <div class="text-center mb-8">
                    <div class="inline-block p-3 bg-green-100 rounded-full text-green-600 mb-4">
                        <i class="fas fa-check-circle text-3xl"></i>
                    </div>
                    <h3 class="text-3xl font-bold text-slate-900">Top Recommendations</h3>
                    <p class="text-slate-600">Based on your inputs and environmental analysis</p>
                </div>

                <div id="recommendations-container" class="grid md:grid-cols-3 gap-6 mb-8">
                    <!-- Populated by JS -->
                </div>

                <div class="bg-slate-50 rounded-2xl p-6">
                    <h4 class="font-bold text-slate-900 mb-4">Environmental Snapshot</h4>
                    <div id="env-snapshot" class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Info Section -->
        <div class="mt-12 text-center">
            <div class="inline-block bg-white/20 backdrop-blur-md rounded-2xl px-6 py-4 border-2 border-white/30">
                <p class="text-white text-sm">
                    <i class="fas fa-info-circle mr-2"></i>
                    Both modes use the same advanced AI model trained on Andhra Pradesh agricultural data
                </p>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Fetch districts on load
    fetch('/get_district_names')
        .then(response => response.json())
        .then(districts => {
            const selects = document.querySelectorAll('.district-select');
            selects.forEach(select => {
                districts.forEach(district => {
                    const option = document.createElement('option');
                    option.value = district;
                    option.textContent = district;
                    select.appendChild(option);
                });
            });
        });

    function showForm(type) {
        document.getElementById('manual-form').classList.add('hidden');
        document.getElementById('auto-form').classList.add('hidden');
        document.getElementById('suggestion-form').classList.add('hidden');
        document.getElementById('results-section').classList.add('hidden');

        if (type === 'manual') {
            document.getElementById('manual-form').classList.remove('hidden');
        } else if (type === 'auto') {
            document.getElementById('auto-form').classList.remove('hidden');
        } else {
            document.getElementById('suggestion-form').classList.remove('hidden');
        }

        // Scroll to form
        document.getElementById(type + '-form').scrollIntoView({
            behavior: 'smooth',
            block: 'center'
        });
    }

    function hideForms() {
        document.getElementById('manual-form').classList.add('hidden');
        document.getElementById('auto-form').classList.add('hidden');
        document.getElementById('suggestion-form').classList.add('hidden');
    }

    async function handleSuggestion(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        const payload = Object.fromEntries(formData.entries());

        const btn = form.querySelector('button[type="submit"]');
        const originalText = btn.textContent;
        btn.textContent = 'Fetching Suggestions...';
        btn.disabled = true;

        try {
            // Redirect to the suggestion page with query params
            const params = new URLSearchParams({
                district: payload.district,
                season: payload.season,
                crop: payload.crop
            });
            window.location.href = `/suggestion?${params.toString()}`;

        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred.');
            btn.textContent = originalText;
            btn.disabled = false;
        }
    }

    async function handlePrediction(event, mode) {
        event.preventDefault();
        console.log('üîç handlePrediction called with mode:', mode);
        const form = event.target;
        const formData = new FormData(form);
        const payload = Object.fromEntries(formData.entries());
        payload.mode = mode;
        console.log('üì¶ Payload:', payload);

        // Show loading state
        const btn = form.querySelector('button[type="submit"]');
        const originalText = btn.textContent;
        btn.textContent = 'Analyzing...';
        btn.disabled = true;

        try {
            console.log('üöÄ Sending POST to /predict...');
            const response = await fetch('/predict', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            });

            console.log('üì° Response status:', response.status);
            const data = await response.json();
            console.log('üìä Response data:', data);

            if (data.error) {
                console.error('‚ùå Error in response:', data.error);
                alert(data.error);
                return;
            }

            console.log('‚úÖ Calling displayResults...');
            displayResults(data);
        } catch (error) {
            console.error('üí• Exception in handlePrediction:', error);
            alert('An error occurred while fetching recommendations.');
        } finally {
            btn.textContent = originalText;
            btn.disabled = false;
        }
    }

    function displayResults(data) {
        console.log('üé® displayResults called with data:', data);
        console.log('üìã Recommendations:', data.recommendations);
        const container = document.getElementById('recommendations-container');
        console.log('üì¶ Container element:', container);
        container.innerHTML = '';

        // Crop emoji mapping
        const cropEmojis = {
            'Paddy': 'üåæ', 'Rice': 'üåæ', 'Wheat': 'üåæ',
            'Maize': 'üåΩ', 'Corn': 'üåΩ',
            'Cotton': 'üå∏',
            'Sugarcane': 'üéã',
            'Groundnut': 'ü•ú', 'Peanut': 'ü•ú',
            'Sunflower': 'üåª',
            'Soybean': 'ü´ò', 'Chickpea': 'ü´ò', 'Pigeon Pea': 'ü´ò',
            'Tomato': 'üçÖ', 'Potato': 'ü•î', 'Onion': 'üßÖ',
            'Chilli': 'üå∂Ô∏è', 'Pepper': 'üå∂Ô∏è',
            'Turmeric': 'üü°',
            'Mango': 'ü•≠', 'Banana': 'üçå', 'Coconut': 'ü••',
            'Cashew': 'üå∞', 'Coffee': '‚òï', 'Tea': 'üçµ',
            'Tobacco': 'üåø',
            'Jowar': 'üåæ', 'Bajra': 'üåæ', 'Ragi': 'üåæ',
            'default': 'üå±'
        };

        data.recommendations.forEach((rec, index) => {
            const isFirst = index === 0;
            const card = document.createElement('div');
            card.className = `p-6 rounded-3xl text-center transition-all duration-500 ${isFirst ? 'bg-gradient-to-br from-green-600 to-emerald-600 text-white shadow-2xl transform scale-105 border-0' : 'bg-white border-2 border-slate-100 text-slate-800 hover:border-green-200'}`;

            const cropEmoji = cropEmojis[rec.crop] || cropEmojis['default'];

            // Correct URL construction for suggestion page
            const params = new URLSearchParams();
            params.append('crop', rec.crop);
            if (data.location_details && data.location_details.district) {
                params.append('district', data.location_details.district);
            }

            card.innerHTML = `
                <div class="text-7xl mb-4 animate-bounce-slow" style="animation-delay: ${index * 0.2}s">${cropEmoji}</div>
                <div class="inline-block px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest mb-3 ${isFirst ? 'bg-white/20 text-white' : 'bg-green-100 text-green-700'}">
                    ${isFirst ? 'üèÜ Top Recommendation' : `‚≠ê Preference ${index + 1}`}
                </div>
                <h3 class="text-3xl font-black mb-1">${rec.crop}</h3>
                <div class="text-sm opacity-80 mb-6 font-medium">Confidence: ${(rec.score * 100).toFixed(1)}%</div>
                
                <div class="grid grid-cols-2 gap-2 mb-6">
                    <div class="${isFirst ? 'bg-black/10' : 'bg-slate-50'} rounded-xl p-2">
                        <div class="text-[10px] uppercase font-bold opacity-60">Rainfall</div>
                        <div class="text-sm font-bold">${data.location_details.rainfall ?? '--'} mm</div>
                    </div>
                    <div class="${isFirst ? 'bg-black/10' : 'bg-slate-50'} rounded-xl p-2">
                        <div class="text-[10px] uppercase font-bold opacity-60">Humidity</div>
                        <div class="text-sm font-bold">${data.location_details.humidity ?? '--'}%</div>
                    </div>
                </div>

                <a href="/suggestion?${params.toString()}" 
                   class="inline-flex items-center justify-center w-full px-5 py-3 rounded-xl font-bold transition-all ${isFirst ? 'bg-white text-green-700 hover:bg-green-50 shadow-lg' : 'bg-green-600 text-white hover:bg-green-700'}">
                    <span>View Plan</span>
                    <i class="fas fa-arrow-right ml-2 text-xs"></i>
                </a>
            `;
            container.appendChild(card);
        });

        // Update Snapshot
        const snapshot = document.getElementById('env-snapshot');
        const loc = data.location_details || {};
        const weather = data.weather?.current || {};

        snapshot.innerHTML = `
            <div class="p-3 bg-white rounded-xl border border-slate-100">
                <div class="text-xs text-slate-500">District</div>
                <div class="font-semibold">${loc.district || '-'}</div>
            </div>
            <div class="p-3 bg-white rounded-xl border border-slate-100">
                <div class="text-xs text-slate-500">Soil Type</div>
                <div class="font-semibold">${loc.soil_type || '-'}</div>
            </div>
            <div class="p-3 bg-white rounded-xl border border-slate-100">
                <div class="text-xs text-slate-500">Rainfall</div>
                <div class="font-semibold">${loc.rainfall ? loc.rainfall + ' mm' : '-'}</div>
            </div>
            <div class="p-3 bg-white rounded-xl border border-slate-100">
                <div class="text-xs text-slate-500">Temperature</div>
                <div class="font-semibold">${weather.temperature ? weather.temperature + '¬∞C' : '-'}</div>
            </div>
        `;

        document.getElementById('results-section').classList.remove('hidden');
        document.getElementById('results-section').scrollIntoView({
            behavior: 'smooth',
            block: 'start'
        });
    }

    // REMOVED: Auto-fill on district change in manual mode
    // Manual mode should require users to enter all values themselves
    // Users can still use the "Detect" button if they want auto-fill

    function autoDetectWeather() {
        if (navigator.geolocation) {
            const btn = document.querySelector('button[onclick="autoDetectWeather()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Locating...';

            navigator.geolocation.getCurrentPosition(async position => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;

                try {
                    const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=relativehumidity_2m`);
                    const data = await response.json();

                    if (data.current_weather) {
                        document.getElementById('input-temperature').value = data.current_weather.temperature;
                        // Estimate humidity (taking first hourly value as approx)
                        if (data.hourly && data.hourly.relativehumidity_2m) {
                            document.getElementById('input-humidity').value = data.hourly.relativehumidity_2m[0];
                        }
                        // Rainfall not directly in current_weather, leaving manual or using 0
                        document.getElementById('input-rainfall').value = 0; // Default
                    }
                    btn.innerHTML = '<i class="fas fa-check mr-1"></i> Filled';
                    setTimeout(() => btn.innerHTML = originalText, 2000);
                } catch (error) {
                    console.error(error);
                    alert('Could not fetch weather data.');
                    btn.innerHTML = originalText;
                }
            }, error => {
                alert('Location access denied.');
                btn.innerHTML = originalText;
            });
        } else {
            alert("Geolocation is not supported by this browser.");
        }
    }

    // REMOVED: Auto-fetch weather on load
    // This was causing unwanted auto-fill in manual mode
    // Users should manually enter values or click the "Detect" button
</script>
{% endblock %}