<div id="agro-chatbot" class="fixed bottom-4 right-4 z-50 flex flex-col items-end gap-2 isolate">
    <!-- Chat Window -->
    <div id="chat-window"
        class="hidden bg-white w-80 md:w-96 rounded-2xl shadow-2xl border border-slate-200 overflow-hidden flex flex-col h-[500px] transition-all duration-300 transform origin-bottom-right scale-95 opacity-0">
        <!-- Header -->
        <div
            class="bg-gradient-to-r from-green-600 to-emerald-600 p-4 flex items-center justify-between text-white shrink-0">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-xl">
                    ü§ñ
                </div>
                <div>
                    <h3 class="font-bold text-sm">Agro Assistant</h3>
                    <div class="flex items-center gap-1.5 opacity-80">
                        <span class="w-2 h-2 rounded-full bg-green-300 animate-pulse"></span>
                        <span class="text-xs">Online</span>
                    </div>
                </div>
            </div>
            <button onclick="toggleChat()" class="hover:bg-white/10 p-2 rounded-lg transition">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- Messages Area -->
        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50 scroll-smooth">
            <!-- Parameters: 'bot' or 'user' -->
            <div class="flex items-start gap-2.5">
                <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center text-sm shrink-0">ü§ñ
                </div>
                <div
                    class="bg-white border-slate-200 border p-3 rounded-2xl rounded-tl-none text-slate-600 text-sm shadow-sm">
                    Namaste! üôè I am your farming assistant. Ask me about:
                    <ul class="list-disc ml-4 mt-2 space-y-1">
                        <li>Farming techniques for [crop]</li>
                        <li>Fertilizer tips</li>
                        <li>Government schemes</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="p-4 bg-white border-t border-slate-100 shrink-0">
            <form id="chat-form" onsubmit="handleChat(event)" class="relative">
                <input type="text" id="chat-input"
                    class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 pr-12 text-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:bg-white transition"
                    placeholder="Type your question..." autocomplete="off">
                <button type="submit"
                    class="absolute right-2 top-1/2 -translate-y-1/2 w-8 h-8 bg-green-600 text-white rounded-lg flex items-center justify-center hover:bg-green-700 transition shadow-sm">
                    <i class="fas fa-paper-plane text-xs"></i>
                </button>
            </form>
        </div>
    </div>

    <!-- Toggle Button -->
    <button onclick="toggleChat()"
        class="w-14 h-14 bg-gradient-to-br from-green-500 to-emerald-600 text-white rounded-full shadow-lg hover:shadow-green-500/30 transition hover:scale-110 flex items-center justify-center text-2xl group">
        <i class="fas fa-comment-alt group-hover:scale-110 transition"></i>
    </button>
</div>

<script>
    const chatWindow = document.getElementById('chat-window');
    const messagesContainer = document.getElementById('chat-messages');

    function toggleChat() {
        chatWindow.classList.toggle('hidden');
        if (!chatWindow.classList.contains('hidden')) {
            requestAnimationFrame(() => {
                chatWindow.classList.remove('scale-95', 'opacity-0');
                chatWindow.classList.add('scale-100', 'opacity-100');
                document.getElementById('chat-input').focus();
            });
        } else {
            chatWindow.classList.remove('scale-100', 'opacity-100');
            chatWindow.classList.add('scale-95', 'opacity-0');
        }
    }

    async function handleChat(e) {
        e.preventDefault();
        const input = document.getElementById('chat-input');
        const message = input.value.trim();
        if (!message) return;

        // User Message
        appendMessage(message, 'user');
        input.value = '';

        // Simulate thinking / specific keywords for quick mock response if offline
        const loadingId = appendLoading();

        try {
            const response = await fetch('/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: message })
            });
            const data = await response.json();
            removeLoading(loadingId);
            appendMessage(data.response, 'bot');
        } catch (error) {
            removeLoading(loadingId);
            appendMessage("Sorry, I'm having trouble connecting to the server.", 'bot');
        }
    }

    function appendMessage(text, sender) {
        const div = document.createElement('div');
        div.className = sender === 'user' ? 'flex items-start justify-end gap-2.5' : 'flex items-start gap-2.5';

        const avatar = sender === 'user'
            ? `<img src="/static/images/avatars/crop_rice.png" class="w-8 h-8 rounded-full shrink-0 border border-slate-200">`
            : `<div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center text-sm shrink-0 border border-green-200">ü§ñ</div>`;

        const bubble = `<div class="${sender === 'user' ? 'bg-green-600 text-white rounded-tr-none' : 'bg-white border border-slate-200 text-slate-600 rounded-tl-none'} p-3 rounded-2xl text-sm shadow-sm max-w-[80%] break-words leading-relaxed">${text}</div>`;

        div.innerHTML = sender === 'user' ? bubble + avatar : avatar + bubble;
        messagesContainer.appendChild(div);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function appendLoading() {
        const id = 'loading-' + Date.now();
        const div = document.createElement('div');
        div.id = id;
        div.className = 'flex items-start gap-2.5';
        div.innerHTML = `
            <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center text-sm shrink-0">ü§ñ</div>
            <div class="bg-white border border-slate-200 p-3 rounded-2xl rounded-tl-none shadow-sm">
                <div class="flex gap-1">
                    <div class="w-2 h-2 bg-slate-400 rounded-full animate-bounce"></div>
                    <div class="w-2 h-2 bg-slate-400 rounded-full animate-bounce delay-75"></div>
                    <div class="w-2 h-2 bg-slate-400 rounded-full animate-bounce delay-150"></div>
                </div>
            </div>
        `;
        messagesContainer.appendChild(div);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        return id;
    }

    function removeLoading(id) {
        const el = document.getElementById(id);
        if (el) el.remove();
    }
</script>