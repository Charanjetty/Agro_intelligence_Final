{% extends "base.html" %}
{% block title %}Live Weather - AgroIntelligence{% endblock %}

{% block head %}
<style>
  /* Match landing page fonts/style */
  .weather-hero {
    background: linear-gradient(135deg, #10b981 0%, #3b82f6 100%);
    /* Green to Blue like landing */
    padding: 6rem 0 4rem;
    /* More spacing */
    color: white;
    text-align: center;
    margin-bottom: -3rem;
    position: relative;
    overflow: hidden;
  }

  /* Add subtle pattern overlay if possible, or just gradient */

  .weather-card-lg {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 24px;
    padding: 2.5rem;
    box-shadow: 0 20px 50px rgba(0, 0, 0, 0.1);
    text-align: center;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border: 1px solid rgba(255, 255, 255, 0.5);
  }

  .weather-card-lg:hover {
    transform: translateY(-5px);
    box-shadow: 0 25px 60px rgba(0, 0, 0, 0.15);
  }

  .forecast-card {
    background: white;
    border-radius: 20px;
    padding: 1.5rem;
    text-align: center;
    border: 1px solid #e2e8f0;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .forecast-card:hover {
    border-color: #3b82f6;
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(59, 130, 246, 0.2);
  }

  .weather-icon-lg {
    font-size: 6rem;
    margin-bottom: 0.5rem;
    filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.1));
    animation: floatIcon 3s ease-in-out infinite;
  }

  @keyframes floatIcon {

    0%,
    100% {
      transform: translateY(0);
    }

    50% {
      transform: translateY(-10px);
    }
  }

  .glass-panel {
    background: white;
    border-radius: 24px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    border: 1px solid #f1f5f9;
    transition: all 0.3s;
  }

  .glass-panel:hover {
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
  }
</style>
{% endblock %}

{% block content %}
<div class="bg-slate-50 min-h-screen -mt-10 -mx-4">

  <!-- Header -->
  <div class="weather-hero">
    <div class="max-w-4xl mx-auto px-4">
      <h1 class="text-4xl md:text-5xl font-extrabold mb-4">Live Weather Insights</h1>
      <p class="text-xl opacity-90 mb-8">Real-time forecasts to help you plan your farming activities</p>

      <div class="bg-white/20 backdrop-blur-md p-2 rounded-2xl inline-flex flex-col md:flex-row gap-2 max-w-full">
        <select id="district-select"
          class="px-6 py-3 rounded-xl text-slate-800 font-bold focus:outline-none min-w-[250px]">
          <option value="">Select District</option>
          <!-- Populated by JS -->
        </select>
        <button onclick="getUserLocation()"
          class="px-6 py-3 bg-white text-blue-600 font-bold rounded-xl hover:bg-blue-50 transition flex items-center justify-center gap-2">
          <i class="fas fa-location-arrow"></i> Use My Location
        </button>
      </div>
    </div>
  </div>

  <div class="max-w-6xl mx-auto px-4 mt-8 pb-12">
    <div id="weather-content" class="hidden">
      <!-- Today's Highlights -->
      <div class="grid md:grid-cols-2 gap-8 mb-12">
        <div class="weather-card-lg flex flex-col justify-center items-center">
          <div class="weather-icon-lg" id="current-icon">‚òÄÔ∏è</div>
          <div class="text-6xl font-black text-slate-800 mb-2" id="current-temp">--¬∞</div>
          <div class="text-xl text-slate-600 font-medium" id="current-condition">Clear Sky</div>
          <div class="mt-4 text-sm text-slate-400" id="current-time">Updated just now</div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div
            class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center justify-center">
            <div class="text-3xl mb-2">üíß</div>
            <div class="text-2xl font-bold text-slate-800" id="current-humidity">--%</div>
            <div class="text-sm text-slate-500">Humidity</div>
          </div>
          <div
            class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center justify-center">
            <div class="text-3xl mb-2">üí®</div>
            <div class="text-2xl font-bold text-slate-800" id="current-wind">-- km/h</div>
            <div class="text-sm text-slate-500">Wind Speed</div>
          </div>
          <div
            class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center justify-center">
            <div class="text-3xl mb-2">‚òî</div>
            <div class="text-2xl font-bold text-slate-800" id="current-rain">-- mm</div>
            <div class="text-sm text-slate-500">Precipitation</div>
          </div>
          <div
            class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center justify-center">
            <div class="text-3xl mb-2">üå±</div>
            <div class="text-2xl font-bold text-slate-800">Good</div>
            <div class="text-sm text-slate-500">Farming Condition</div>
          </div>
        </div>
      </div>

      <!-- Crop Advisory -->
      <div id="advice-container" class="hidden mb-12 bg-green-50 border border-green-200 rounded-2xl p-6">
        <h3 class="text-xl font-bold text-green-800 mb-4 flex items-center gap-2">
          <i class="fas fa-leaf"></i> Crop Advisory based on Weather
        </h3>
        <div id="advice-list" class="text-green-900 font-medium"></div>
      </div>

      <!-- Forecast -->
      <h2 class="text-2xl font-bold text-slate-900 mb-6" id="forecast-title">Hourly Forecast</h2>
      <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4" id="forecast-container">
        <!-- Populated by JS -->
      </div>
    </div>

    <!-- Loading / Empty State -->
    <div id="loading-state" class="text-center py-20">
      <div class="text-6xl mb-4 animate-bounce">‚òÅÔ∏è</div>
      <h3 class="text-2xl font-bold text-slate-400">Select a district to see weather</h3>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Fetch districts on load
  fetch('/get_district_names')
    .then(response => response.json())
    .then(districts => {
      const select = document.getElementById('district-select');
      districts.forEach(district => {
        const option = document.createElement('option');
        option.value = district;
        option.textContent = district;
        select.appendChild(option);
      });
    });

  document.getElementById('district-select').addEventListener('change', (e) => {
    if (e.target.value) {
      fetchWeather(e.target.value);
    }
  });

  function getUserLocation() {
    const btn = document.querySelector('button[onclick="getUserLocation"]');
    const originalText = btn.innerHTML;

    if (!navigator.geolocation) {
      alert("Geolocation is not supported by your browser");
      return;
    }

    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Locating...';
    btn.disabled = true;

    navigator.geolocation.getCurrentPosition(
      async (position) => {
        try {
          const lat = position.coords.latitude;
          const lon = position.coords.longitude;

          const response = await fetch(`/api/nearest-district?lat=${lat}&lon=${lon}`);
          const data = await response.json();

          if (data.error) throw new Error(data.error);

          const select = document.getElementById('district-select');
          select.value = data.district;

          // Trigger change event to fetch weather
          select.dispatchEvent(new Event('change'));

          btn.innerHTML = `<i class="fas fa-location-dot"></i> ${data.district}`;
          setTimeout(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
          }, 3000);

        } catch (error) {
          console.error(error);
          alert("Could not find nearest district. Please select manually.");
          btn.innerHTML = originalText;
          btn.disabled = false;
        }
      },
      (error) => {
        console.error(error);
        let msg = "Unable to retrieve your location";
        if (error.code === 1) msg = "Location permission denied";
        alert(msg);
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    );
  }

  async function fetchWeather(district) {
    document.getElementById('loading-state').innerHTML = '<div class="text-4xl animate-spin">‚è≥</div><p class="mt-4">Fetching live data...</p>';
    document.getElementById('weather-content').classList.add('hidden');

    try {
      const response = await fetch(`/api/weather/${district}`);
      const data = await response.json();

      if (data.error) throw new Error(data.error);

      updateUI(data);
    } catch (error) {
      alert("Could not fetch weather data");
      document.getElementById('loading-state').innerHTML = '<div class="text-4xl">‚ùå</div><p class="mt-4">Error loading data</p>';
    }
  }

  function updateUI(data) {
    const current = data.current;
    document.getElementById('current-temp').textContent = Math.round(current.temperature) + '¬∞';
    document.getElementById('current-wind').textContent = current.windspeed + ' km/h';
    document.getElementById('current-time').textContent = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

    // Simple condition logic (mock)
    const code = current.weathercode;
    let icon = '‚òÄÔ∏è';
    let condition = 'Clear Sky';
    if (code > 3) { icon = '‚òÅÔ∏è'; condition = 'Cloudy'; }
    if (code > 50) { icon = 'üåßÔ∏è'; condition = 'Rainy'; }
    if (code > 70) { icon = '‚õàÔ∏è'; condition = 'Storm'; }

    document.getElementById('current-icon').textContent = icon;
    document.getElementById('current-condition').textContent = condition;

    // Use first hourly record for humidity if current missing
    if (data.hourly && data.hourly.length > 0) {
      document.getElementById('current-humidity').textContent = data.hourly[0].humidity + '%';
      document.getElementById('current-rain').textContent = data.hourly[0].precipitation + ' mm';
    }

    // Crop Advisory
    if (data.advice && data.advice.length > 0) {
      const adviceContainer = document.getElementById('advice-container');
      if (adviceContainer) {
        let html = '<ul class="space-y-2">';
        data.advice.forEach(item => {
          html += `<li class="flex items-start gap-2"><i class="fas fa-check-circle text-green-600 mt-1"></i><span>${item}</span></li>`;
        });
        html += '</ul>';
        document.getElementById('advice-list').innerHTML = html;
        adviceContainer.classList.remove('hidden');
      }
    }

    // Daily Forecast (Weekly)
    const container = document.getElementById('forecast-container');
    container.innerHTML = '';
    document.getElementById('forecast-title').textContent = "7-Day Forecast";

    if (data.daily) {
      data.daily.forEach(day => {
        const date = new Date(day.date);
        const dateStr = date.toLocaleDateString('en-US', { weekday: 'short', day: 'numeric' });

        // Simple icon logic
        let icon = '‚òÄÔ∏è';
        if (day.rain_sum > 0) icon = 'üåßÔ∏è';
        else if (day.max_temp < 20) icon = '‚ùÑÔ∏è';
        else if (day.max_temp > 35) icon = 'üî•';

        const card = document.createElement('div');
        card.className = 'forecast-card';
        card.innerHTML = `
            <div class="text-sm font-bold text-slate-500 mb-2">${dateStr}</div>
            <div class="text-3xl mb-2">${icon}</div>
            <div class="font-bold text-lg text-slate-800">${Math.round(day.max_temp)}¬∞ <span class="text-slate-400 text-sm">/ ${Math.round(day.min_temp)}¬∞</span></div>
            <div class="text-xs text-blue-500 mt-1 font-semibold">${day.rain_sum}mm Rain</div>
        `;
        container.appendChild(card);
      });
    }

    document.getElementById('loading-state').classList.add('hidden');
    document.getElementById('weather-content').classList.remove('hidden');
  }
</script>
{% endblock %}